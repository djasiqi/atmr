2025-11-21T16:07:45.4784855Z ##[group]Run # Lancer pytest depuis la racine pour que les imports 'backend' fonctionnent
2025-11-21T16:07:45.4785772Z [36;1m# Lancer pytest depuis la racine pour que les imports 'backend' fonctionnent[0m
2025-11-21T16:07:45.4786927Z [36;1mpytest backend/tests -v --cov=backend --cov-report=xml:backend/coverage.xml --cov-report=html:backend/htmlcov --cov-report=term-missing[0m
2025-11-21T16:07:45.4817733Z shell: /usr/bin/bash -e {0}
2025-11-21T16:07:45.4818086Z env:
2025-11-21T16:07:45.4818618Z   DATABASE_URL: ***localhost:5432/atmr_test
2025-11-21T16:07:45.4819009Z   PGHOST: localhost
2025-11-21T16:07:45.4819318Z   PGPORT: 5432
2025-11-21T16:07:45.4819585Z   PGUSER: test
2025-11-21T16:07:45.4819841Z   PGPASSWORD: test
2025-11-21T16:07:45.4820123Z   PGDATABASE: atmr_test
2025-11-21T16:07:45.4820477Z   REDIS_URL: redis://localhost:6379/0
2025-11-21T16:07:45.4820858Z   FLASK_CONFIG: testing
2025-11-21T16:07:45.4821185Z   SECRET_KEY: test-secret-key
2025-11-21T16:07:45.4821524Z   JWT_SECRET_KEY: test-jwt-secret
2025-11-21T16:07:45.4822319Z   APP_ENCRYPTION_KEY_B64: MDEyMzQ1Njc4OWFiY2RlZjAxMjM0NTY3ODlhYmNkZWY
2025-11-21T16:07:45.4822854Z   API_LEGACY_ENABLED: false
2025-11-21T16:07:45.4823220Z   PYTHONPATH: /home/runner/work/atmr/atmr
2025-11-21T16:07:45.4823615Z   SOCKETIO_ASYNC_MODE: threading
2025-11-21T16:07:45.4823980Z   SKIP_SOCKETIO: true
2025-11-21T16:07:45.4824343Z   SKIP_ROUTES_INIT: true
2025-11-21T16:07:45.4824765Z   pythonLocation: /opt/hostedtoolcache/Python/3.11.14/x64
2025-11-21T16:07:45.4825447Z   PKG_CONFIG_PATH: /opt/hostedtoolcache/Python/3.11.14/x64/lib/pkgconfig
2025-11-21T16:07:45.4826119Z   Python_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.14/x64
2025-11-21T16:07:45.4826740Z   Python2_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.14/x64
2025-11-21T16:07:45.4827376Z   Python3_ROOT_DIR: /opt/hostedtoolcache/Python/3.11.14/x64
2025-11-21T16:07:45.4827995Z   LD_LIBRARY_PATH: /opt/hostedtoolcache/Python/3.11.14/x64/lib
2025-11-21T16:07:45.4828462Z ##[endgroup]
2025-11-21T16:07:47.9149321Z ============================= test session starts ==============================
2025-11-21T16:07:47.9150350Z platform linux -- Python 3.11.14, pytest-9.0.1, pluggy-1.6.0 -- /opt/hostedtoolcache/Python/3.11.14/x64/bin/python
2025-11-21T16:07:47.9151115Z cachedir: .pytest_cache
2025-11-21T16:07:47.9151492Z rootdir: /home/runner/work/atmr/atmr/backend
2025-11-21T16:07:47.9151918Z configfile: pytest.ini
2025-11-21T16:07:47.9152569Z plugins: flask-1.3.0, Faker-38.2.0, cov-7.0.0
2025-11-21T16:08:02.0886825Z collecting ... collected 2976 items
2025-11-21T16:08:02.0887237Z 
2025-11-21T16:08:02.1644236Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlValidations::test_validate_interface_valid PASSED [  0%]
2025-11-21T16:08:02.1698275Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlValidations::test_validate_interface_invalid PASSED [  0%]
2025-11-21T16:08:02.1753208Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlValidations::test_validate_latency_ms_valid PASSED [  0%]
2025-11-21T16:08:02.1807299Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlValidations::test_validate_latency_ms_invalid PASSED [  0%]
2025-11-21T16:08:02.1869416Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlValidations::test_validate_jitter_ms_valid PASSED [  0%]
2025-11-21T16:08:02.1923914Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlValidations::test_validate_jitter_ms_invalid PASSED [  0%]
2025-11-21T16:08:02.1977075Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlValidations::test_validate_percent_valid PASSED [  0%]
2025-11-21T16:08:02.2031717Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlValidations::test_validate_percent_invalid PASSED [  0%]
2025-11-21T16:08:02.2085726Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlManager::test_init_valid_interface PASSED [  0%]
2025-11-21T16:08:02.2142382Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlManager::test_init_invalid_interface PASSED [  0%]
2025-11-21T16:08:02.2213471Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlManager::test_add_latency_success PASSED [  0%]
2025-11-21T16:08:02.2281844Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlManager::test_add_latency_no_root PASSED [  0%]
2025-11-21T16:08:02.2357608Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlManager::test_add_latency_invalid_params PASSED [  0%]
2025-11-21T16:08:02.2422661Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlManager::test_add_latency_timeout PASSED [  0%]
2025-11-21T16:08:02.2487508Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlManager::test_add_packet_loss_success PASSED [  0%]
2025-11-21T16:08:02.2551183Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlManager::test_add_packet_loss_invalid_percent PASSED [  0%]
2025-11-21T16:08:02.2615587Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlManager::test_clear_success PASSED [  0%]
2025-11-21T16:08:02.2675985Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlManager::test_is_active_success PASSED [  0%]
2025-11-21T16:08:02.2751261Z backend/tests/chaos/test_traffic_control.py::TestTrafficControlManager::test_is_active_timeout PASSED [  0%]
2025-11-21T16:08:02.8627487Z backend/tests/e2e/test_disaster_scenarios.py::TestDisasterScenarios::test_osrm_down_10_min PASSED [  0%]
2025-11-21T16:08:03.2461407Z backend/tests/e2e/test_disaster_scenarios.py::TestDisasterScenarios::test_db_read_only FAILED [  0%]
2025-11-21T16:08:03.6994527Z backend/tests/e2e/test_disaster_scenarios.py::TestDisasterScenarios::test_pic_load_500_requests PASSED [  0%]
2025-11-21T16:08:03.7065635Z backend/tests/e2e/test_disaster_scenarios.py::TestDisasterScenarios::test_network_flaky PASSED [  0%]
2025-11-21T16:08:04.1297427Z backend/tests/e2e/test_disaster_scenarios.py::TestDisasterScenarios::test_combined_disaster PASSED [  0%]
2025-11-21T16:08:04.2446885Z backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_dispatch_async_complet FAILED [  0%]
2025-11-21T16:08:04.4139676Z backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_dispatch_sync_limite_10_bookings PASSED [  0%]
2025-11-21T16:08:04.6921262Z backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_validation_temporelle_stricte_rollback FAILED [  0%]
2025-11-21T16:08:04.8078053Z backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_rollback_transactionnel_complet FAILED [  0%]
2025-11-21T16:08:05.0258318Z backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_recovery_apres_crash PASSED [  0%]
2025-11-21T16:08:05.3345150Z backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_batch_dispatches FAILED [  1%]
2025-11-21T16:08:05.4416608Z backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_dispatch_run_id_correlation FAILED [  1%]
2025-11-21T16:08:05.5412362Z backend/tests/e2e/test_dispatch_metrics_e2e.py::test_metrics_endpoint_accessible FAILED [  1%]
2025-11-21T16:08:05.6411011Z backend/tests/e2e/test_dispatch_metrics_e2e.py::test_metrics_format_valid FAILED [  1%]
2025-11-21T16:08:05.7416196Z backend/tests/e2e/test_dispatch_metrics_e2e.py::test_dispatch_metrics_present FAILED [  1%]
2025-11-21T16:08:07.8500549Z backend/tests/e2e/test_dispatch_metrics_e2e.py::test_dispatch_increments_metrics PASSED [  1%]
2025-11-21T16:08:07.8668212Z backend/tests/e2e/test_dispatch_metrics_e2e.py::test_metrics_correlation_with_logs PASSED [  1%]
2025-11-21T16:08:07.9613519Z backend/tests/e2e/test_dispatch_metrics_e2e.py::test_osrm_metrics_present PASSED [  1%]
2025-11-21T16:08:08.0660512Z backend/tests/e2e/test_dispatch_metrics_e2e.py::test_slo_metrics_present FAILED [  1%]
2025-11-21T16:08:08.0661468Z 
2025-11-21T16:08:08.0661673Z =================================== FAILURES ===================================
2025-11-21T16:08:08.0662474Z ___________________ TestDisasterScenarios.test_db_read_only ____________________
2025-11-21T16:08:08.0663231Z backend/tests/e2e/test_disaster_scenarios.py:188: in test_db_read_only
2025-11-21T16:08:08.0663861Z     assert response_get.status_code in [200, 404], (
2025-11-21T16:08:08.0664894Z E   AssertionError: GET devrait fonctionner même en read-only, reçu: 302
2025-11-21T16:08:08.0665467Z E   assert 302 in [200, 404]
2025-11-21T16:08:08.0665961Z E    +  where 302 = <WrapperTestResponse streamed [302 FOUND]>.status_code
2025-11-21T16:08:08.0666457Z _________________ TestDispatchE2E.test_dispatch_async_complet __________________
2025-11-21T16:08:08.0666880Z backend/tests/e2e/test_dispatch_e2e.py:93: in test_dispatch_async_complet
2025-11-21T16:08:08.0667289Z     assert dispatch_run is not None, "DispatchRun should be created"
2025-11-21T16:08:08.0667640Z E   AssertionError: DispatchRun should be created
2025-11-21T16:08:08.0667899Z E   assert None is not None
2025-11-21T16:08:08.0668191Z ------------------------------ Captured log call -------------------------------
2025-11-21T16:08:08.0668909Z WARNING  services.unified_dispatch.engine:engine.py:232 [Engine] Company 4 introuvable
2025-11-21T16:08:08.0669696Z _________ TestDispatchE2E.test_validation_temporelle_stricte_rollback __________
2025-11-21T16:08:08.0670513Z backend/tests/e2e/test_dispatch_e2e.py:168: in test_validation_temporelle_stricte_rollback
2025-11-21T16:08:08.0671514Z     assert booking1.driver_id is None, "Booking1 ne devrait pas être assigné après rollback"
2025-11-21T16:08:08.0672185Z E   AssertionError: Booking1 ne devrait pas être assigné après rollback
2025-11-21T16:08:08.0672567Z E   assert 15 is None
2025-11-21T16:08:08.0672779Z E    +  where 15 = <Booking 26>.driver_id
2025-11-21T16:08:08.0673090Z ------------------------------ Captured log call -------------------------------
2025-11-21T16:08:08.0673687Z ERROR    services.unified_dispatch.data:data.py:356 [DATA] 🔍 FILTRAGE de 2 courses pour retours non confirmés...
2025-11-21T16:08:08.0674518Z ERROR    services.unified_dispatch.data:data.py:375 [DATA] ✅ 2 courses après filtrage (0 retours exclus avec heure à confirmer)
2025-11-21T16:08:08.0675388Z WARNING  services.unified_dispatch.data:data.py:1039 [Dispatch] ⚠️ Fairness counts vides pour 3 chauffeurs (date=2025-11-21) — vérifier statuts/horaires
2025-11-21T16:08:08.0676198Z INFO     services.osrm_client:osrm_client.py:932 [OSRM] build_distance_matrix_osrm_with_cb entry: n=7 base_url=http://osrm:5000 timeout=5
2025-11-21T16:08:08.0676826Z INFO     services.osrm_client:osrm_client.py:936 [OSRM] build_distance_matrix_osrm_with_cb success: shape=7x7
2025-11-21T16:08:08.0677622Z WARNING  services.unified_dispatch.data:data.py:1039 [Dispatch] ⚠️ Fairness counts vides pour 3 chauffeurs (date=2025-11-21) — vérifier statuts/horaires
2025-11-21T16:08:08.0678542Z INFO     services.osrm_client:osrm_client.py:932 [OSRM] build_distance_matrix_osrm_with_cb entry: n=7 base_url=http://osrm:5000 timeout=5
2025-11-21T16:08:08.0679170Z INFO     services.osrm_client:osrm_client.py:936 [OSRM] build_distance_matrix_osrm_with_cb success: shape=7x7
2025-11-21T16:08:08.0679955Z WARNING  services.unified_dispatch.data:data.py:1039 [Dispatch] ⚠️ Fairness counts vides pour 3 chauffeurs (date=2025-11-21) — vérifier statuts/horaires
2025-11-21T16:08:08.0680713Z INFO     services.osrm_client:osrm_client.py:932 [OSRM] build_distance_matrix_osrm_with_cb entry: n=7 base_url=http://osrm:5000 timeout=5
2025-11-21T16:08:08.0681333Z INFO     services.osrm_client:osrm_client.py:936 [OSRM] build_distance_matrix_osrm_with_cb success: shape=7x7
2025-11-21T16:08:08.0682397Z WARNING  services.unified_dispatch.heuristics:heuristics.py:1186 [HEURISTIC] 🔍 Début scoring de 2 courses régulières avec 3 chauffeurs (parallel=False)...
2025-11-21T16:08:08.0683556Z WARNING  services.unified_dispatch.heuristics:heuristics.py:2030 [DISPATCH] ⚠️ Conflit temporel détaillé (scored_pool): course #26 (fin 10:26) et #27 (début 10:00) → temps nécessaire: 57min, écart disponible: -62.0min
2025-11-21T16:08:08.0684854Z WARNING  services.unified_dispatch.heuristics:heuristics.py:2060 [DISPATCH] 🔴 Conflit temporel (final) booking #27 + driver #15: temps_insuffisant: nécessaire=57min, écart=-62.0min (course #26 fin 10:26 vs course #27 début 10:00)
2025-11-21T16:08:08.0686149Z WARNING  services.unified_dispatch.rl_optimizer:rl_optimizer.py:81 [RLOptimizer] Modèle non trouvé: data/rl/models/dispatch_optimized_v2.pth. Optimisation RL désactivée.
2025-11-21T16:08:08.0687125Z WARNING  services.unified_dispatch.data:data.py:1039 [Dispatch] ⚠️ Fairness counts vides pour 3 chauffeurs (date=2025-11-21) — vérifier statuts/horaires
2025-11-21T16:08:08.0687876Z INFO     services.osrm_client:osrm_client.py:932 [OSRM] build_distance_matrix_osrm_with_cb entry: n=5 base_url=http://osrm:5000 timeout=5
2025-11-21T16:08:08.0688511Z INFO     services.osrm_client:osrm_client.py:936 [OSRM] build_distance_matrix_osrm_with_cb success: shape=5x5
2025-11-21T16:08:08.0689323Z WARNING  services.unified_dispatch.engine:engine.py:1224 [Engine] 📥 Injection état vers fallback: busy_until={15: 636, 14: 0, 13: 0}, proposed_load={15: 1, 14: 0, 13: 0}
2025-11-21T16:08:08.0690332Z WARNING  services.unified_dispatch.heuristics:heuristics.py:2515 [FALLBACK] 📥 Récupération état précédent: busy_until={15: 636, 14: 0, 13: 0}, scheduled_times={15: [600], 14: [], 13: []}
2025-11-21T16:08:08.0691346Z WARNING  services.unified_dispatch.heuristics:heuristics.py:2636 [FALLBACK] ⚠️ CONFLIT: Chauffeur #15 a course à 600min, course #27 à 600min (écart: 0min) → SKIP
2025-11-21T16:08:08.0692363Z WARNING  services.unified_dispatch.heuristics:heuristics.py:2648 [FALLBACK] 🔴 Conflit temporel booking #27 + driver #15: time_gap:0min
2025-11-21T16:08:08.0693071Z ERROR    app:notification_service.py:134 [notify_dispatch_run_completed] emit failed: company_id=21 dispatch_run_id=3
2025-11-21T16:08:08.0693533Z Traceback (most recent call last):
2025-11-21T16:08:08.0699764Z   File "/home/runner/work/atmr/atmr/backend/services/notification_service.py", line 126, in notify_dispatch_run_completed
2025-11-21T16:08:08.0700485Z     app_logger.info("[notify_dispatch_run_completed] Emitting payload: %s", payload)
2025-11-21T16:08:08.0701076Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/logging/__init__.py", line 1489, in info
2025-11-21T16:08:08.0701529Z     self._log(INFO, msg, args, **kwargs)
2025-11-21T16:08:08.0701956Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/logging/__init__.py", line 1634, in _log
2025-11-21T16:08:08.0702608Z     self.handle(record)
2025-11-21T16:08:08.0703015Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/logging/__init__.py", line 1644, in handle
2025-11-21T16:08:08.0703433Z     self.callHandlers(record)
2025-11-21T16:08:08.0703871Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/logging/__init__.py", line 1706, in callHandlers
2025-11-21T16:08:08.0704463Z     hdlr.handle(record)
2025-11-21T16:08:08.0704850Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/logging/__init__.py", line 978, in handle
2025-11-21T16:08:08.0705251Z     self.emit(record)
2025-11-21T16:08:08.0705681Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/site-packages/_pytest/logging.py", line 384, in emit
2025-11-21T16:08:08.0706139Z     super().emit(record)
2025-11-21T16:08:08.0706519Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/logging/__init__.py", line 1118, in emit
2025-11-21T16:08:08.0706925Z     self.handleError(record)
2025-11-21T16:08:08.0707320Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/logging/__init__.py", line 1110, in emit
2025-11-21T16:08:08.0707722Z     msg = self.format(record)
2025-11-21T16:08:08.0707929Z           ^^^^^^^^^^^^^^^^^^^
2025-11-21T16:08:08.0708349Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/logging/__init__.py", line 953, in format
2025-11-21T16:08:08.0708754Z     return fmt.format(record)
2025-11-21T16:08:08.0708957Z            ^^^^^^^^^^^^^^^^^^
2025-11-21T16:08:08.0709391Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/site-packages/_pytest/logging.py", line 137, in format
2025-11-21T16:08:08.0709842Z     return super().format(record)
2025-11-21T16:08:08.0710057Z            ^^^^^^^^^^^^^^^^^^^^^^
2025-11-21T16:08:08.0710540Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/logging/__init__.py", line 687, in format
2025-11-21T16:08:08.0710962Z     record.message = record.getMessage()
2025-11-21T16:08:08.0711211Z                      ^^^^^^^^^^^^^^^^^^^
2025-11-21T16:08:08.0711641Z   File "/opt/hostedtoolcache/Python/3.11.14/x64/lib/python3.11/logging/__init__.py", line 377, in getMessage
2025-11-21T16:08:08.0712182Z     msg = msg % self.args
2025-11-21T16:08:08.0712526Z           ~~~~^~~~~~~~~~~
2025-11-21T16:08:08.0712820Z TypeError: not all arguments converted during string formatting
2025-11-21T16:08:08.0713556Z WARNING  services.unified_dispatch.engine:engine.py:1699 [Engine] ⚠️ 2 conflits temporels détectés pendant ce dispatch
2025-11-21T16:08:08.0714260Z WARNING  services.unified_dispatch.engine:engine.py:1726 [Engine] ⚠️ Cache OSRM hit-rate bas: 0.00%
2025-11-21T16:08:08.0714985Z WARNING  services.unified_dispatch.engine:engine.py:1754 [Engine] ⚠️ SLO breach détecté: 1 violations pour batch size 2
2025-11-21T16:08:08.0715559Z _____________ TestDispatchE2E.test_rollback_transactionnel_complet _____________
2025-11-21T16:08:08.0716027Z backend/tests/e2e/test_dispatch_e2e.py:215: in test_rollback_transactionnel_complet
2025-11-21T16:08:08.0716415Z     assert len(result["applied"]) == 2
2025-11-21T16:08:08.0716651Z E   assert 0 == 2
2025-11-21T16:08:08.0716832Z E    +  where 0 = len([])
2025-11-21T16:08:08.0717113Z ------------------------------ Captured log call -------------------------------
2025-11-21T16:08:08.0717792Z WARNING  services.unified_dispatch.apply:apply.py:472 [Apply] Skipped booking_id=28 reason=booking_not_found_or_wrong_company scheduled_time=None time_confirmed=None is_return=None
2025-11-21T16:08:08.0718772Z WARNING  services.unified_dispatch.apply:apply.py:472 [Apply] Skipped booking_id=29 reason=booking_not_found_or_wrong_company scheduled_time=None time_confirmed=None is_return=None
2025-11-21T16:08:08.0719446Z ____________________ TestDispatchE2E.test_batch_dispatches _____________________
2025-11-21T16:08:09.0124420Z backend/tests/e2e/test_dispatch_e2e.py:291: in test_batch_dispatches
2025-11-21T16:08:09.0125059Z     assert len(dispatch_run_ids) > 0, "At least one dispatch_run_id should be returned"
2025-11-21T16:08:09.0125482Z E   AssertionError: At least one dispatch_run_id should be returned
2025-11-21T16:08:09.0125795Z E   assert 0 > 0
2025-11-21T16:08:09.0125994Z E    +  where 0 = len([])
2025-11-21T16:08:09.0126282Z ------------------------------ Captured log call -------------------------------
2025-11-21T16:08:09.0126739Z WARNING  services.unified_dispatch.engine:engine.py:232 [Engine] Company 36 introuvable
2025-11-21T16:08:09.0127573Z WARNING  services.unified_dispatch.engine:engine.py:232 [Engine] Company 36 introuvable
2025-11-21T16:08:09.0128070Z WARNING  services.unified_dispatch.engine:engine.py:232 [Engine] Company 36 introuvable
2025-11-21T16:08:09.0128521Z _______________ TestDispatchE2E.test_dispatch_run_id_correlation _______________
2025-11-21T16:08:09.0128982Z backend/tests/e2e/test_dispatch_e2e.py:309: in test_dispatch_run_id_correlation
2025-11-21T16:08:09.0129340Z     assert dispatch_run_id is not None
2025-11-21T16:08:09.0129571Z E   assert None is not None
2025-11-21T16:08:09.0129862Z ------------------------------ Captured log call -------------------------------
2025-11-21T16:08:09.0130290Z WARNING  services.unified_dispatch.engine:engine.py:232 [Engine] Company 57 introuvable
2025-11-21T16:08:09.0130721Z _______________________ test_metrics_endpoint_accessible _______________________
2025-11-21T16:08:09.0131142Z backend/tests/e2e/test_dispatch_metrics_e2e.py:84: in test_metrics_endpoint_accessible
2025-11-21T16:08:09.0131518Z     assert response.status_code == 200
2025-11-21T16:08:09.0131749Z E   assert 302 == 200
2025-11-21T16:08:09.0132205Z E    +  where 302 = <WrapperTestResponse streamed [302 FOUND]>.status_code
2025-11-21T16:08:09.0132585Z __________________________ test_metrics_format_valid ___________________________
2025-11-21T16:08:09.0133098Z backend/tests/e2e/test_dispatch_metrics_e2e.py:94: in test_metrics_format_valid
2025-11-21T16:08:09.0133442Z     assert "# TYPE" in content
2025-11-21T16:08:09.0134386Z E   assert '# TYPE' in '<!doctype html>\n<html lang=en>\n<title>Redirecting...</title>\n<h1>Redirecting...</h1>\n<p>You should be redirected automatically to the target URL: <a href="https://localhost:5000/api/v1/prometheus/metrics">https://localhost:5000/api/v1/prometheus/metrics</a>. If not, click the link.\n'
2025-11-21T16:08:09.0135557Z ________________________ test_dispatch_metrics_present _________________________
2025-11-21T16:08:09.0135990Z backend/tests/e2e/test_dispatch_metrics_e2e.py:120: in test_dispatch_metrics_present
2025-11-21T16:08:09.0136610Z     assert metric in content, f"Métrique {metric} non trouvée"
2025-11-21T16:08:09.0137028Z E   AssertionError: Métrique dispatch_runs_total non trouvée
2025-11-21T16:08:09.0138028Z E   assert 'dispatch_runs_total' in '<!doctype html>\n<html lang=en>\n<title>Redirecting...</title>\n<h1>Redirecting...</h1>\n<p>You should be redirected automatically to the target URL: <a href="https://localhost:5000/api/v1/prometheus/metrics">https://localhost:5000/api/v1/prometheus/metrics</a>. If not, click the link.\n'
2025-11-21T16:08:09.0139044Z ___________________________ test_slo_metrics_present ___________________________
2025-11-21T16:08:09.0139447Z backend/tests/e2e/test_dispatch_metrics_e2e.py:210: in test_slo_metrics_present
2025-11-21T16:08:09.0139910Z     assert metric in content, f"Métrique SLO {metric} non trouvée"
2025-11-21T16:08:09.0140346Z E   AssertionError: Métrique SLO dispatch_slo_breaches_total non trouvée
2025-11-21T16:08:09.0141411Z E   assert 'dispatch_slo_breaches_total' in '<!doctype html>\n<html lang=en>\n<title>Redirecting...</title>\n<h1>Redirecting...</h1>\n<p>You should be redirected automatically to the target URL: <a href="https://localhost:5000/api/v1/prometheus/metrics">https://localhost:5000/api/v1/prometheus/metrics</a>. If not, click the link.\n'
2025-11-21T16:08:09.0142502Z =========================== short test summary info ============================
2025-11-21T16:08:09.0143289Z FAILED backend/tests/e2e/test_disaster_scenarios.py::TestDisasterScenarios::test_db_read_only - AssertionError: GET devrait fonctionner même en read-only, reçu: 302
2025-11-21T16:08:09.0143871Z assert 302 in [200, 404]
2025-11-21T16:08:09.0144159Z  +  where 302 = <WrapperTestResponse streamed [302 FOUND]>.status_code
2025-11-21T16:08:09.0144754Z FAILED backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_dispatch_async_complet - AssertionError: DispatchRun should be created
2025-11-21T16:08:09.0145357Z assert None is not None
2025-11-21T16:08:09.0146064Z FAILED backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_validation_temporelle_stricte_rollback - AssertionError: Booking1 ne devrait pas être assigné après rollback
2025-11-21T16:08:09.0146678Z assert 15 is None
2025-11-21T16:08:09.0146872Z  +  where 15 = <Booking 26>.driver_id
2025-11-21T16:08:09.0147324Z FAILED backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_rollback_transactionnel_complet - assert 0 == 2
2025-11-21T16:08:09.0147774Z  +  where 0 = len([])
2025-11-21T16:08:09.0148292Z FAILED backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_batch_dispatches - AssertionError: At least one dispatch_run_id should be returned
2025-11-21T16:08:09.0148829Z assert 0 > 0
2025-11-21T16:08:09.0149002Z  +  where 0 = len([])
2025-11-21T16:08:09.0149429Z FAILED backend/tests/e2e/test_dispatch_e2e.py::TestDispatchE2E::test_dispatch_run_id_correlation - assert None is not None
2025-11-21T16:08:09.0150089Z FAILED backend/tests/e2e/test_dispatch_metrics_e2e.py::test_metrics_endpoint_accessible - assert 302 == 200
2025-11-21T16:08:09.0150582Z  +  where 302 = <WrapperTestResponse streamed [302 FOUND]>.status_code
2025-11-21T16:08:09.0151788Z FAILED backend/tests/e2e/test_dispatch_metrics_e2e.py::test_metrics_format_valid - assert '# TYPE' in '<!doctype html>\n<html lang=en>\n<title>Redirecting...</title>\n<h1>Redirecting...</h1>\n<p>You should be redirected automatically to the target URL: <a href="https://localhost:5000/api/v1/prometheus/metrics">https://localhost:5000/api/v1/prometheus/metrics</a>. If not, click the link.\n'
2025-11-21T16:08:09.0153432Z FAILED backend/tests/e2e/test_dispatch_metrics_e2e.py::test_dispatch_metrics_present - AssertionError: Métrique dispatch_runs_total non trouvée
2025-11-21T16:08:09.0154668Z assert 'dispatch_runs_total' in '<!doctype html>\n<html lang=en>\n<title>Redirecting...</title>\n<h1>Redirecting...</h1>\n<p>You should be redirected automatically to the target URL: <a href="https://localhost:5000/api/v1/prometheus/metrics">https://localhost:5000/api/v1/prometheus/metrics</a>. If not, click the link.\n'
2025-11-21T16:08:09.0156009Z FAILED backend/tests/e2e/test_dispatch_metrics_e2e.py::test_slo_metrics_present - AssertionError: Métrique SLO dispatch_slo_breaches_total non trouvée
2025-11-21T16:08:09.0157282Z assert 'dispatch_slo_breaches_total' in '<!doctype html>\n<html lang=en>\n<title>Redirecting...</title>\n<h1>Redirecting...</h1>\n<p>You should be redirected automatically to the target URL: <a href="https://localhost:5000/api/v1/prometheus/metrics">https://localhost:5000/api/v1/prometheus/metrics</a>. If not, click the link.\n'
2025-11-21T16:08:09.0158301Z !!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 10 failures !!!!!!!!!!!!!!!!!!!!!!!!!!
2025-11-21T16:08:09.0158630Z ================= 10 failed, 28 passed, 33 warnings in 20.16s ==================
2025-11-21T16:08:10.1110818Z ##[error]Process completed with exit code 1.
