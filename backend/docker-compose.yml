version: "3.9"

services:
  api:
    image: docker.io/djasiqi/atmr-backend:latest
    env_file: .env.production
    command: gunicorn wsgi:app -k sync -w 4 -b 0.0.0.0:5000
    depends_on:
      - postgres
      - redis
      - osrm
    expose:
      - "5000"
    volumes:
      - ./logs:/app/logs
      - ./migrations:/app/migrations:ro
    restart: unless-stopped
    networks:
      - traefik_proxy
      - internal
    labels:
      - traefik.enable=true
      - traefik.http.routers.atmr_api.rule=Host(`api.lirie.ch`)
      - traefik.http.routers.atmr_api.entrypoints=websecure
      - traefik.http.routers.atmr_api.tls.certresolver=letsencrypt
      - traefik.http.services.atmr_api.loadbalancer.server.port=5000
      - traefik.docker.network=traefik_proxy

  celery-worker:
    image: docker.io/djasiqi/atmr-backend:latest
    env_file: .env.production
    command: celery -A celery_app.celery worker --loglevel=INFO --concurrency=4
    depends_on:
      - redis
      - postgres
    volumes:
      - ./migrations:/app/migrations:ro
    restart: unless-stopped
    networks:
      - internal

  celery-beat:
    image: docker.io/djasiqi/atmr-backend:latest
    env_file: .env.production
    command: celery -A celery_app.celery beat --loglevel=INFO
    depends_on:
      - redis
      - postgres
    volumes:
      - ./migrations:/app/migrations:ro
    restart: unless-stopped
    networks:
      - internal

  migrations:
    image: docker.io/djasiqi/atmr-backend:latest
    env_file: .env.production
    environment:
      ALEMBIC_CONFIG: /app/migrations/alembic.ini
    command: alembic -c /app/migrations/alembic.ini upgrade head
    depends_on:
      - postgres
    volumes:
      - ./migrations:/app/migrations:ro
    networks:
      - internal
    restart: "no"

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ../redis/data:/data
    restart: unless-stopped
    networks:
      - internal

  postgres:
    image: postgres:16-alpine
    env_file: .env.production
    volumes:
      - ../postgres/data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 30s
      timeout: 5s
      retries: 5

  osrm:
    image: osrm/osrm-backend:latest
    command: ["osrm-routed", "--algorithm", "mld", "/data/map.osrm"]
    volumes:
      - ../osrm/data:/data
    restart: unless-stopped
    networks:
      - internal

networks:
  traefik_proxy:
    external: true
  internal:
    name: atmr_internal
