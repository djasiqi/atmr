version: "3.9"

services:
  api:
    image: docker.io/djasiqi/atmr-backend:latest
    env_file: .env.production
    command: gunicorn wsgi:app -k sync -w 4 -b 0.0.0.0:5000
    depends_on:
      - postgres
      - redis
      - osrm
    expose:
      - "5000"
    volumes:
      - ./logs:/app/logs
      - ./migrations:/app/migrations:ro
    restart: unless-stopped
    networks:
      - traefik_proxy
      - internal
    labels:
      - traefik.enable=true
      - traefik.http.routers.atmr_api.rule=Host(`api.lirie.ch`)
      - traefik.http.routers.atmr_api.entrypoints=websecure
      - traefik.http.routers.atmr_api.tls.certresolver=letsencrypt
      - traefik.http.services.atmr_api.loadbalancer.server.port=5000
      - traefik.docker.network=traefik_proxy
    healthcheck:
      test:
        - CMD
        - python
        - -c
        - |
          import json
          import sys
          from urllib.request import urlopen, URLError, HTTPError

          try:
              with urlopen("http://127.0.0.1:5000/health", timeout=5) as response:
                  if response.status != 200:
                      sys.exit(1)
                  data = json.loads(response.read().decode())
          except (URLError, HTTPError, TimeoutError):
              sys.exit(1)
          else:
              if data.get("status") == "healthy" and data.get("models_loaded"):
                  sys.exit(0)
              sys.exit(1)
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  celery-worker:
    image: docker.io/djasiqi/atmr-backend:latest
    env_file: .env.production
    command: celery -A celery_app.celery worker --loglevel=INFO --concurrency=4
    depends_on:
      - redis
      - postgres
    volumes:
      - ./migrations:/app/migrations:ro
    restart: unless-stopped
    networks:
      - internal
    healthcheck:
      test:
        - CMD
        - celery
        - -A
        - celery_app:celery
        - inspect
        - ping
        - -d
        - celery@$$HOSTNAME
        - -t
        - "5"
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  celery-beat:
    image: docker.io/djasiqi/atmr-backend:latest
    env_file: .env.production
    command: celery -A celery_app.celery beat --loglevel=INFO
    depends_on:
      - redis
      - postgres
    volumes:
      - ./migrations:/app/migrations:ro
    restart: unless-stopped
    networks:
      - internal
    healthcheck:
      test:
        - CMD-SHELL
        - test -f /app/celerybeat-schedule.dat && echo 'ok' || exit 1
      interval: 1m
      timeout: 5s
      retries: 3
      start_period: 30s

  migrations:
    image: docker.io/djasiqi/atmr-backend:latest
    env_file: .env.production
    environment:
      ALEMBIC_CONFIG: /app/migrations/alembic.ini
    command: alembic -c /app/migrations/alembic.ini upgrade head
    depends_on:
      - postgres
    volumes:
      - ./migrations:/app/migrations:ro
    networks:
      - internal
    restart: "no"

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ../redis/data:/data
    restart: unless-stopped
    networks:
      - internal

  postgres:
    image: postgres:16-alpine
    env_file: .env.production
    volumes:
      - ../postgres/data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 30s
      timeout: 5s
      retries: 5

  osrm:
    image: osrm/osrm-backend:latest
    command: ["osrm-routed", "--algorithm", "mld", "/data/map.osrm"]
    volumes:
      - ../osrm/data:/data
    restart: unless-stopped
    networks:
      - internal

networks:
  traefik_proxy:
    external: true
  internal:
    name: atmr_internal
