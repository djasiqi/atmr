[pytest]
# Configuration pytest optimisée pour ATMR
# Les options peuvent être surchargées en ligne de commande si nécessaire
# Le workflow GitHub Actions spécifie explicitement 'backend/tests', donc testpaths
# n'est utilisé que si aucun chemin n'est spécifié en ligne de commande

# Répertoire des tests (utilisé si aucun chemin n'est spécifié)
testpaths = tests

# Patterns pour détecter les fichiers, classes et fonctions de test
python_files = test_*.py *_test.py
python_classes = Test*
python_functions = test_*

# Options par défaut pour tous les tests
# -v : verbose (affiche chaque test)
# --disable-warnings : désactive les avertissements pour une sortie plus propre
# --tb=short : traceback court en cas d'erreur
# --maxfail=10 : arrêter après 10 échecs (utile pour voir plusieurs erreurs)
addopts =
    -v
    --disable-warnings
    --tb=short
    --maxfail=10

# Configuration du coverage
# Note: Les options de coverage peuvent être surchargées en ligne de commande
# pour le workflow GitHub Actions ou les tests spécifiques
[coverage:run]
source = backend
omit =
    */tests/*
    */migrations/*
    */venv/*
    */__pycache__/*
    */htmlcov/*
    */instance/*
    */temp_*/*
    */scripts/*
    */docs/*
    */node_modules/*

[coverage:report]
# Seuil de couverture minimum global (peut être surchargé)
fail_under = 70
precision = 2
show_missing = True
skip_covered = False
#
# Seuils spécifiques par module (selon plan d'audit, vérifiés par scripts/check_coverage.py):
# - backend/services/unified_dispatch/* : ≥95%
# - backend/routes/auth.py : ≥95%
# - backend/services/osrm_client.py : ≥90%
# - backend/services/rl/dispatch_env.py : ≥85%
# - Autres modules critiques : ≥80% (seuil par défaut)

# Marqueurs personnalisés pour catégoriser les tests
markers =
    unit: Tests unitaires rapides
    integration: Tests d'intégration
    e2e: Tests end-to-end
    slow: Tests lents (peuvent être exclus avec -m "not slow")
    rl: Tests Reinforcement Learning
    osrm: Tests OSRM
    pii: Tests PII masking
    dispatch: Tests dispatch
    ml: Tests Machine Learning

# Options de logging (optionnel, pour debug)
log_cli = false
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(name)s: %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# Options de performance
# timeout : timeout par défaut pour les tests (peut être surchargé)
# timeout_method : méthode pour gérer les timeouts
timeout = 300
timeout_method = thread

